from flask import Flask, render_template, request, redirect, url_for, session, flash
import json
import os

app = Flask(__name__)
app.secret_key = "secret_key_for_session"  # خليها سرية في المشاريع الحقيقية

USERS_FILE = "users.json"

# تحميل المستخدمين من الملف أو إنشاء ملف جديد لو مش موجود
def load_users():
    if os.path.exists(USERS_FILE):
        with open(USERS_FILE, "r") as f:
            return json.load(f)
    else:
        return {}

# حفظ المستخدمين في الملف
def save_users(users):
    with open(USERS_FILE, "w") as f:
        json.dump(users, f)

@app.route("/")
def home():
    if "username" in session:
        return f"أهلا {session['username']}! أنت مسجل دخول كـ {session['role']} <br><a href='/logout'>تسجيل خروج</a>"
    return redirect(url_for("login"))

@app.route("/register", methods=["GET", "POST"])
def register():
    if request.method == "POST":
        username = request.form["username"]
        phone = request.form["phone"]
        role = request.form["role"]

        users = load_users()
        if username in users:
            flash("الاسم مستخدم بالفعل!")
            return redirect(url_for("register"))

        users[username] = {"phone": phone, "role": role}
        save_users(users)
        flash("تم التسجيل بنجاح! يمكنك الآن تسجيل الدخول.")
        return redirect(url_for("login"))

    return '''
    <h2>إنشاء حساب</h2>
    <form method="post">
        الاسم: <input type="text" name="username" required><br>
        رقم الهاتف: <input type="text" name="phone" required><br>
        اختر الدور:
        <select name="role" required>
            <option value="عامل">عامل</option>
            <option value="شريك">شريك</option>
            <option value="تاجر">تاجر</option>
        </select><br><br>
        <input type="submit" value="تسجيل">
    </form>
    '''

@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        username = request.form["username"]

        users = load_users()
        if username in users:
            session["username"] = username
            session["role"] = users[username]["role"]
            return redirect(url_for("home"))
        else:
            flash("اسم المستخدم غير موجود!")
            return redirect(url_for("login"))

    return '''
    <h2>تسجيل دخول</h2>
    <form method="post">
        الاسم: <input type="text" name="username" required><br>
        <input type="submit" value="دخول">
    </form>
    '''

@app.route("/logout")
def logout():
    session.pop("username", None)
    session.pop("role", None)
    return redirect(url_for("login"))

if __name__ == "__main__":
    app.run(debug=True)
